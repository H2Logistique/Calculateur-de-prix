<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Devis Déménagement - H2 Logistique</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel pour traduire le JSX en direct -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Style pour l'impression -->
    <style>
        @media print {
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- COMPOSANTS ICONES ---
        const Lock = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;
        const Unlock = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>;
        const Calculator = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg>;
        const Save = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const Info = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
        const ArrowLeft = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const Edit3 = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>;
        const TableIcon = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 3H5a2 2 0 0 0-2 2v4h6V3z"></path><path d="M9 21H5a2 2 0 0 1-2-2v-4h6v6z"></path><path d="M21 3h-4v6h6V5a2 2 0 0 0-2-2z"></path><path d="M21 21h-4v-6h6v4a2 2 0 0 1-2 2z"></path><rect x="9" y="3" width="6" height="18"></rect></svg>;
        const ChevronDown = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const ChevronUp = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>;
        const Trash2 = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const RotateCcw = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>;
        const KeyRound = ({size, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"></path><circle cx="16.5" cy="7.5" r=".5"></circle></svg>;

        // --- DONNÉES INITIALES ---

        const INITIAL_DATA = {
          prestation: [
            { id: 'p1', name: 'Cubage', defaultPrice: 35 },
            { id: 'p2', name: 'Etages sans ascenseur', defaultPrice: 0.80 }, 
            { 
              id: 'p3', 
              name: 'Démontage / Remontage', 
              defaultPrice: 40, 
              info: "Si mobilier complexe ou long à démonter / remonter alors indiquer '2' pour ce mobilier"
            },
            { id: 'p4', name: 'Portage (en m)', defaultPrice: 0.50 }, // Prix unitaire 0.50€
            { 
              id: 'p8', 
              name: "Distance d'approche (en km)", 
              defaultPrice: 0.65, 
              unit: 'km', 
              info: "Remplir si l'approche de Paris + Trajet > 50km (Ne pas remplir pour les longue distance)" 
            },
          ],
          ra_monte_meuble: [
             { 
              id: 'p5', 
              name: 'Monte-meuble 1/2 journée', 
              defaultPrice: 220, 
              info: "Majoration si l'inventaire contient un piano ou si l'étage est au 9ieme ou +"
            },
            { 
              id: 'p6', 
              name: 'Monte-meuble 1 journée', 
              defaultPrice: 320, 
              info: "Majoration si l'inventaire contient un piano ou si l'étage est au 9ieme ou +"
            },
            { id: 'p7', name: 'AOT (Autorisation Stationnement)', defaultPrice: 25 },
            { id: 'ra1', name: 'Supplément > 8ème étage', defaultPrice: 40, info: "Supplément pour étages 9 et 10" },
            { id: 'ra2', name: 'Monte-meuble > 10ème (1/2 journée)', defaultPrice: 400, info: "Tarif spécial haute hauteur" },
            { id: 'ra3', name: 'Monte-meuble > 10ème (Journée)', defaultPrice: 700, info: "Tarif spécial haute hauteur" },
          ],
          materiel: [
            { id: 'm1', name: 'Cartons Standard', defaultPrice: 1 },
            { id: 'm2', name: 'Cartons Livre', defaultPrice: 1.00 },
            { id: 'm3', name: 'Cartons Penderie', defaultPrice: 10.00 },
            { 
              id: 'm4', 
              name: 'Papier bulle', 
              defaultPrice: 7, 
              info: "10 cartons vaisselle = 1 papier bulle"
            },
            { 
              id: 'm5', 
              name: 'Scotch', 
              defaultPrice: 2, 
              info: "20 cartons = 1 scotch"
            },
            { id: 'm6', name: 'Livraison', defaultPrice: 30.00, readOnlyQuantity: true },
          ],
          confort: [
            { id: 'c1', name: 'Pack Confort (Emballage Fragile)', defaultPrice: 150, info: "Emballage vaisselle, verrerie et bibelots" },
          ],
          distance: [
            { id: 'l1', name: 'Nombre de camions', defaultPrice: 1200, readOnlyQuantity: true },
            { id: 'l2', name: 'Distance kilométrique', defaultPrice: 2.20, unit: 'km', info: "Si > 550km : 2.2€/km (Remplace le prix camion). Sinon forfait 1200€ s'applique." }, 
            { id: 'l3', name: 'Chargement le matin', defaultPrice: 400, info: "400€ (1-2 camions) / 800€ (3+ camions)" },
            { id: 'l4', name: 'Option Groupage', defaultPrice: 0, info: "Active le tarif groupage (Plafonné au prix longue distance)" },
          ],
          groupage: [
            { id: 'g1', name: 'Forfait Groupage', defaultPrice: 0, readOnlyQuantity: true, info: "Calculé sur la base du cubage ou de la distance" },
          ]
        };

        // 2. Génération de la Grille Tarifaire (Matrix)
        const generateInitialMatrix = () => {
          const matrix = [];
          for (let m3 = 1; m3 <= 80; m3++) {
            let totalPrice = 135; 
            let etage = 0.80; 
            let portage = 0.50; // Mise à jour dynamique aussi
            let confort = 150;
            
            if (m3 >= 66) totalPrice = 435; 
            else if (m3 >= 46) totalPrice = 335; 
            else if (m3 >= 26) totalPrice = 235; 
            else {
                if (m3 === 1) totalPrice = 170;
                if (m3 === 2) totalPrice = 150;
                if (m3 === 3) totalPrice = 145;
                if (m3 === 4 || m3 === 5) totalPrice = 140;
            }

            const priceString = totalPrice.toString();
            const camion = parseInt(priceString.charAt(0)); 
            const prixRestant = parseInt(priceString.substring(1));
            const distance = camion * 1200;

            if (m3 >= 66) confort = 700;
            else if (m3 >= 46) confort = 600;
            else if (m3 >= 30) confort = 500;
            else if (m3 >= 20) confort = 400;
            else if (m3 >= 16) confort = 300;
            else if (m3 >= 14) confort = 250;
            else if (m3 >= 10) confort = 200;

            matrix.push({
              id: `vol-${m3}`,
              m3: m3,
              camion: camion,
              prix: prixRestant,
              etage: etage,
              portage: portage,
              confort: confort,
              distance: distance
            });
          }
          return matrix;
        };

        // --- COMPOSANTS ---

        const AdminPage = ({ prices, setPrices, matrixData, setMatrixData, onBack, initialData }) => {
          const handleMatrixChange = (id, field, value) => {
            const numValue = parseFloat(value);
            setMatrixData(prev => prev.map(row => 
              row.id === id ? { ...row, [field]: isNaN(numValue) ? 0 : numValue } : row
            ));
          };

          const handlePriceChange = (id, value) => {
            const val = parseFloat(value) || 0;
            setPrices(prev => ({ ...prev, [id]: val >= 0 ? val : 0 }));
          };

          const renderPriceEditSection = (title, items) => (
            <div>
              <h4 className="font-semibold text-slate-700 mb-3 border-b pb-2">{title}</h4>
              <div className="space-y-3">
                {items.map(item => (
                  <div key={item.id} className="flex justify-between items-center bg-slate-50 p-3 rounded">
                    <span className="text-sm font-medium text-slate-700">{item.name}</span>
                    <div className="flex items-center gap-2">
                      <input 
                        type="number" 
                        value={prices[item.id]} 
                        onChange={(e) => handlePriceChange(item.id, e.target.value)}
                        className="w-24 p-1 text-right border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                      />
                      <span className="text-slate-500 text-sm">€</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );

          return (
            <div className="bg-white min-h-screen pb-12">
              <div className="bg-slate-900 text-white px-6 py-4 sticky top-0 z-20 shadow-md flex justify-between items-center no-print">
                <div className="flex items-center gap-3">
                  <Lock size={24} className="text-red-400" />
                  <h2 className="text-xl font-bold">Console Administrateur</h2>
                </div>
                <button onClick={onBack} className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors">
                  <ArrowLeft size={16} /> Retour
                </button>
              </div>

              <div className="max-w-7xl mx-auto p-6 space-y-8">
                <p className="text-slate-500 italic border-l-4 border-blue-500 pl-4 py-2 bg-blue-50">
                  Toutes les modifications sont sauvegardées pour la session en cours.
                </p>

                <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div className="bg-slate-100 px-6 py-4 border-b border-slate-200 flex items-center gap-2">
                    <Edit3 size={20} className="text-blue-600" />
                    <h3 className="font-bold text-lg text-slate-800">1. Prix Unitaires</h3>
                  </div>
                  <div className="p-6 grid md:grid-cols-2 gap-8">
                    {renderPriceEditSection("Prestation", initialData.prestation)}
                    {renderPriceEditSection("Monte Meuble & AOT", initialData.ra_monte_meuble)}
                    {renderPriceEditSection("Matériel", initialData.materiel)}
                    {renderPriceEditSection("Confort", initialData.confort)}
                    {renderPriceEditSection("Longue Distance", initialData.distance)}
                  </div>
                </section>

                <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                  <div className="bg-slate-100 px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <TableIcon size={20} className="text-purple-600" />
                      <h3 className="font-bold text-lg text-slate-800">2. Grille Tarifaire Cubage</h3>
                    </div>
                    <div className="text-xs text-slate-500 bg-white px-2 py-1 rounded border">
                      {matrixData.length} lignes chargées
                    </div>
                  </div>
                  
                  <div className="flex-1 overflow-auto">
                    <table className="w-full text-sm text-left border-collapse">
                      <thead className="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                          <th className="px-4 py-3 border-b border-r bg-slate-100 w-16 text-center">m³</th>
                          <th className="px-4 py-3 border-b w-24 text-center bg-amber-50 text-amber-900 border-r border-amber-100">Camion</th>
                          <th className="px-4 py-3 border-b w-32 text-right text-blue-800">Prix (€)</th>
                          <th className="px-4 py-3 border-b w-32 text-right">Étage (€)</th>
                          <th className="px-4 py-3 border-b w-32 text-right">Portage (€)</th>
                          <th className="px-4 py-3 border-b w-32 text-right">Confort (€)</th>
                          <th className="px-4 py-3 border-b w-40 text-right text-purple-800">Longue Dist. (€)</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {matrixData.map((row) => (
                          <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                            <td className="px-4 py-2 font-bold text-center bg-slate-50 border-r text-slate-700">{row.m3}</td>
                            <td className="px-2 py-1 bg-amber-50/50 border-r border-amber-100">
                              <input 
                                type="number" 
                                value={row.camion}
                                onChange={(e) => handleMatrixChange(row.id, 'camion', e.target.value)}
                                className="w-full text-center p-2 border border-transparent hover:border-amber-300 focus:border-amber-500 focus:bg-amber-100 rounded outline-none bg-transparent font-bold text-amber-700"
                              />
                            </td>
                            <td className="px-2 py-1"><input type="number" value={row.prix} onChange={(e) => handleMatrixChange(row.id, 'prix', e.target.value)} className="w-full text-right p-2 border border-transparent hover:border-slate-300 focus:border-blue-500 focus:bg-blue-50 rounded outline-none bg-transparent font-medium text-blue-700" /></td>
                            <td className="px-2 py-1"><input type="number" step="0.10" value={row.etage} onChange={(e) => handleMatrixChange(row.id, 'etage', e.target.value)} className="w-full text-right p-2 border border-transparent hover:border-slate-300 focus:border-blue-500 focus:bg-blue-50 rounded outline-none bg-transparent" /></td>
                            <td className="px-2 py-1"><input type="number" step="0.10" value={row.portage} onChange={(e) => handleMatrixChange(row.id, 'portage', e.target.value)} className="w-full text-right p-2 border border-transparent hover:border-slate-300 focus:border-blue-500 focus:bg-blue-50 rounded outline-none bg-transparent" /></td>
                            <td className="px-2 py-1"><input type="number" value={row.confort} onChange={(e) => handleMatrixChange(row.id, 'confort', e.target.value)} className="w-full text-right p-2 border border-transparent hover:border-slate-300 focus:border-blue-500 focus:bg-blue-50 rounded outline-none bg-transparent" /></td>
                            <td className="px-2 py-1 bg-purple-50/30"><input type="number" value={row.distance} onChange={(e) => handleMatrixChange(row.id, 'distance', e.target.value)} className="w-full text-right p-2 border border-transparent hover:border-slate-300 focus:border-purple-500 focus:bg-purple-50 rounded outline-none bg-transparent font-medium text-purple-700" /></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </section>
              </div>
            </div>
          );
        };

        // Composant de section de table pliable
        const TableSection = ({ 
          title, 
          items, 
          colorClass, 
          quantities, 
          prices, 
          onQuantityChange, 
          formatCurrency,
          calculateRowTotal,
          defaultExpanded = true,
          quantityLabel = "Quantité",
          disableQuantityInput = false,
          extraHeaderContent = null,
          onClear 
        }) => {
          const [isExpanded, setIsExpanded] = useState(defaultExpanded);
          const sectionTotal = items.reduce((sum, item) => sum + calculateRowTotal(item.id), 0);
          const booleanItems = ['p5', 'p6', 'p7', 'l3', 'l4', 'ra1', 'ra2', 'ra3'];

          return (
            <div className="mb-4 bg-white rounded-lg shadow-sm overflow-hidden border border-slate-200">
              <div className={`px-6 py-4 ${colorClass} border-b border-slate-200`}>
                <div className="flex justify-between items-center">
                    <div 
                        className="flex items-center gap-3 cursor-pointer select-none flex-grow"
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <h3 className="font-bold text-lg">{title}</h3>
                        {!isExpanded && (
                            <span className="text-sm font-medium text-slate-800 bg-white px-2 py-0.5 rounded-full shadow-sm">
                                {formatCurrency(sectionTotal)}
                            </span>
                        )}
                    </div>
                    
                    <div className="flex items-center gap-4">
                        {extraHeaderContent && (
                            <div onClick={(e) => e.stopPropagation()}>
                                {extraHeaderContent}
                            </div>
                        )}

                        <button 
                            onClick={(e) => { e.stopPropagation(); onClear(items); }}
                            className="opacity-70 hover:opacity-100 hover:text-red-400 p-1 rounded transition-colors"
                            title="Effacer ce segment"
                        >
                            <Trash2 size={18} />
                        </button>
                        
                        <div 
                            className="cursor-pointer ml-2"
                            onClick={() => setIsExpanded(!isExpanded)}
                        >
                            {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                        </div>
                    </div>
                </div>
              </div>
              
              {isExpanded && (
                <div className="overflow-x-auto animate-in fade-in slide-in-from-top-2 duration-200">
                    <table className="w-full text-sm text-left">
                    <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                        <tr>
                        <th className="px-6 py-3 w-1/3">Désignation</th>
                        <th className="px-6 py-3 w-1/4 text-center">{quantityLabel}</th>
                        <th className="px-6 py-3 w-1/4 text-right">Unité de prix</th>
                        <th className="px-6 py-3 w-1/6 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {items.map((item) => {
                        const qtyValue = quantities[item.id];
                        const displayQty = (qtyValue === 0 || qtyValue === undefined) ? '' : qtyValue;
                        const isBoolean = booleanItems.includes(item.id);
                        const isDisabled = disableQuantityInput || item.readOnlyQuantity;
                        
                        return (
                            <tr key={item.id} className="border-b hover:bg-slate-50 transition-colors">
                            <td className="px-6 py-4 font-medium text-slate-900">
                                <div className="flex items-center gap-2">
                                <span>{item.name}</span>
                                {item.info && (
                                    <div className="group relative flex items-center cursor-help">
                                    <Info size={16} className="text-blue-400 hover:text-blue-600" />
                                    <div className="absolute left-full ml-2 w-48 p-2 bg-slate-800 text-white text-xs rounded z-50 hidden group-hover:block shadow-lg">{item.info}</div>
                                    </div>
                                )}
                                </div>
                            </td>
                            <td className="px-6 py-4 text-center">
                                {isBoolean ? (
                                    <div className="flex justify-center gap-1">
                                        <button onClick={() => onQuantityChange(item.id, 1)} className={`px-3 py-1 text-xs font-semibold rounded-l-md border transition-colors ${qtyValue === 1 ? 'bg-green-600 text-white border-green-600' : 'bg-slate-100 text-slate-500 border-slate-200 hover:bg-slate-200'}`}>OUI</button>
                                        <button onClick={() => onQuantityChange(item.id, 0)} className={`px-3 py-1 text-xs font-semibold rounded-r-md border transition-colors ${qtyValue === 0 ? 'bg-red-600 text-white border-red-600' : 'bg-slate-100 text-slate-500 border-slate-200 hover:bg-slate-200'}`}>NON</button>
                                    </div>
                                ) : (
                                    <input type="number" min="0" max="999" value={displayQty} placeholder="0" disabled={isDisabled} onChange={(e) => onQuantityChange(item.id, e.target.value)} className={`w-24 text-center p-2 border border-slate-300 rounded-md outline-none transition-all ${isDisabled ? 'bg-slate-100 text-slate-500 cursor-not-allowed' : 'focus:ring-2 focus:ring-blue-500 focus:border-blue-500'}`} />
                                )}
                            </td>
                            <td className="px-6 py-4 text-right">
                                {item.id === 'l2' ? <span className="text-slate-600 font-medium">{formatCurrency(prices[item.id])}</span> :
                                 item.id === 'l4' ? <span className="text-slate-400 text-xs italic">Option</span> :
                                 item.id === 'g1' ? <span className="text-slate-400 text-xs italic">Forfait</span> :
                                 <span className="text-slate-600 font-medium">{formatCurrency(prices[item.id])}</span>}
                            </td>
                            <td className="px-6 py-4 text-right font-bold text-slate-700">{formatCurrency(calculateRowTotal(item.id))}</td>
                            </tr>
                        );
                        })}
                        <tr className="bg-slate-50 font-bold border-t-2 border-slate-200">
                        <td colSpan="3" className="px-6 py-4 text-right text-slate-600 uppercase text-xs tracking-wider">Sous-total {title}</td>
                        <td className="px-6 py-4 text-right text-slate-800 text-base">{formatCurrency(sectionTotal)}</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
              )}
            </div>
          );
        };

        const App = () => {
          const [view, setView] = useState('calculator'); 
          const [isAppAccessible, setIsAppAccessible] = useState(false);
          const [accessCode, setAccessCode] = useState('');
          const [accessError, setAccessError] = useState('');

          // Prix Unitaires
          const [prices, setPrices] = useState(() => {
            const initialPrices = {};
            [...INITIAL_DATA.prestation, ...INITIAL_DATA.ra_monte_meuble, ...INITIAL_DATA.materiel, ...INITIAL_DATA.confort, ...INITIAL_DATA.distance, ...INITIAL_DATA.groupage].forEach(item => initialPrices[item.id] = item.defaultPrice);
            return initialPrices;
          });

          const [quantities, setQuantities] = useState(() => {
            const initialQuantities = {};
            [...INITIAL_DATA.prestation, ...INITIAL_DATA.ra_monte_meuble, ...INITIAL_DATA.materiel, ...INITIAL_DATA.confort, ...INITIAL_DATA.distance, ...INITIAL_DATA.groupage].forEach(item => {
              initialQuantities[item.id] = 0;
            });
            return initialQuantities;
          });

          const [matrixData, setMatrixData] = useState(() => generateInitialMatrix());
          const [adjustment, setAdjustment] = useState(0);
          const [showLogin, setShowLogin] = useState(false);
          const [passwordInput, setPasswordInput] = useState('');
          const [loginError, setLoginError] = useState('');

          // --- LOGIQUE DE MISE À JOUR DYNAMIQUE DES PRIX ---
          const updatePricesBasedOnCubage = (cubageValue) => {
            const volume = parseInt(cubageValue) || 0;
            if (volume <= 0) return;
            const row = matrixData.find(r => r.m3 === volume);
            if (row) {
              setPrices(prev => ({ ...prev, 'p1': row.prix, 'p2': row.etage, 'p4': row.portage, 'c1': row.confort, 'l1': 1200 }));
              setQuantities(prev => ({ ...prev, 'l1': row.camion }));
            }
          };

          const handleAccessSubmit = (e) => {
            e.preventDefault();
            if (accessCode === '1010') { setIsAppAccessible(true); setAccessError(''); } else { setAccessError("Code d'accès incorrect"); }
          };

          const handleLogin = (e) => {
            e.preventDefault();
            if (passwordInput === '2525') { setView('admin'); setShowLogin(false); setPasswordInput(''); setLoginError(''); } else { setLoginError('Mot de passe incorrect'); }
          };

          const handleQuantityChange = (id, value) => {
            let newVal = 0;
            if (typeof value === 'number') newVal = value;
            else if (value !== '') { newVal = parseInt(value); if (isNaN(newVal)) newVal = 0; }

            setQuantities(prev => {
                const nextQuantities = { ...prev, [id]: value === '' ? 0 : newVal };
                const materialIds = ['m1', 'm2', 'm3', 'm4', 'm5'];
                if (materialIds.includes(id)) {
                    const hasMaterial = materialIds.some(matId => { const q = (matId === id) ? newVal : prev[matId]; return q > 0; });
                    nextQuantities['m6'] = hasMaterial ? 1 : 0;
                }
                return nextQuantities;
            });
            if (id === 'p1') updatePricesBasedOnCubage(newVal);
          };

          const handleClearSection = (items) => {
            setQuantities(prev => {
                const nextQuantities = { ...prev };
                let isMaterielSection = false;
                items.forEach(item => {
                    if (!item.readOnlyQuantity) nextQuantities[item.id] = 0;
                    if (['m1', 'm2', 'm3', 'm4', 'm5'].includes(item.id)) isMaterielSection = true;
                });
                if (items.some(i => i.id === 'p1')) nextQuantities['l1'] = 0;
                if (isMaterielSection) nextQuantities['m6'] = 0;
                return nextQuantities;
            });
          };

          const handleGlobalClear = () => {
            const initialQs = {};
            [...INITIAL_DATA.prestation, ...INITIAL_DATA.ra_monte_meuble, ...INITIAL_DATA.materiel, ...INITIAL_DATA.confort, ...INITIAL_DATA.distance, ...INITIAL_DATA.groupage].forEach(item => initialQs[item.id] = 0);
            setQuantities(initialQs);
            setAdjustment(0);
          };

          const calculateRowTotal = (id) => {
            const qty = quantities[id] || 0;
            const price = prices[id] || 0;
            const isGroupageActive = quantities['l4'] === 1;
            const isMorningActive = quantities['l3'] === 1;

            if (id === 'p8') {
                if (qty < 50) return 0;
                const nbCamions = quantities['l1'] || 0;
                return qty * price * nbCamions;
            }
            if (id === 'p2') {
              const cubageQty = quantities['p1'] || 0;
              const rawTotal = price * cubageQty * qty;
              return Math.floor(rawTotal / 10) * 10;
            }
            if (id === 'p4') {
                // MODIFICATION : Si quantité < 31, total = 0
                if (qty < 31) return 0;

                const cubageQty = quantities['p1'] || 0;
                const nbCamions = quantities['l1'] || 0; 
                // Formule: Unité de prix (0.5€) * quantité * nombre de camion
                const rawTotal = price * qty * nbCamions;
                return Math.floor(rawTotal / 10) * 10;
            }
            const dist = quantities['l2'] || 0;
            const applyKmPrice = dist > 550;

            if (id === 'l1') { if (isGroupageActive || applyKmPrice) return 0; return qty * 1200; }
            if (id === 'l2') { 
                if (applyKmPrice) { 
                    if (isGroupageActive) { 
                        // Cas B Groupage (> 550km)
                        const cubage = quantities['p1'] || 0; 
                        const groupageCalc = ((dist * 2.2) / 20) * cubage * 1.2; 
                        const standardPrice = dist * 2.2;
                        return Math.min(groupageCalc, standardPrice);
                    } 
                    return dist * 2.2; 
                } 
                return 0; 
            }
            if (id === 'l3') { 
                if (isGroupageActive) return 0; 
                const nbCamions = quantities['l1'] || 0; 
                if (qty === 1) return nbCamions >= 3 ? 800 : 400; 
                return 0; 
            }
            if (id === 'l4') { 
                if (qty === 1) { 
                    if (applyKmPrice) {
                        return 0; 
                    } else { 
                        // Cas A Groupage (<= 550km)
                        const cubage = quantities['p1'] || 0; 
                        const groupageCalc = (cubage * (1200 / 20)) * 1.2;
                        const nbCamions = quantities['l1'] || 0;
                        const standardPrice = nbCamions * 1200;
                        return Math.min(groupageCalc, standardPrice);
                    } 
                } 
                return 0; 
            }
            if (id === 'g1') return 0; 
            
            if (['ra1', 'ra2', 'ra3'].includes(id)) {
                return qty * price;
            }

            return qty * price;
          };

          const calculateSectionTotal = (items) => items.reduce((sum, item) => sum + calculateRowTotal(item.id), 0);
          const formatCurrency = (value) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(value);
          const roundTo10 = (val) => Math.floor(val / 10) * 10;

          const cubageQty = quantities['p1'] || 0;
          const prestationTotal = calculateSectionTotal(INITIAL_DATA.prestation);
          const raTotal = calculateSectionTotal(INITIAL_DATA.ra_monte_meuble);
          const materielTotalRaw = calculateSectionTotal(INITIAL_DATA.materiel);
          const distanceSectionTotal = calculateSectionTotal(INITIAL_DATA.distance);
          const materielTotal = roundTo10(materielTotalRaw);
          const baseTotal = roundTo10(prestationTotal + raTotal + materielTotal);
          const confortTotalBase = cubageQty > 0 ? roundTo10(baseTotal + (prices['c1'] || 0)) : 0;
          
          // Calcul Offre 3:
          const p1Total = calculateRowTotal('p1');
          const p8Total = calculateRowTotal('p8');
          const prestationLongDistanceAddon = prestationTotal - p1Total - p8Total;
          const thirdOfferTotalBase = roundTo10(distanceSectionTotal + materielTotal + raTotal + prestationLongDistanceAddon);

          const applyAdjustment = (amount) => amount + (amount * (adjustment / 100));
          const standardFinal = roundTo10(applyAdjustment(baseTotal));
          const confortFinal = roundTo10(applyAdjustment(confortTotalBase));
          const thirdOfferFinal = roundTo10(applyAdjustment(thirdOfferTotalBase));
          const standardAdjAmount = standardFinal - baseTotal;
          const confortAdjAmount = confortFinal - confortTotalBase;
          const thirdOfferAdjAmount = thirdOfferFinal - thirdOfferTotalBase;
          const isGroupageActive = quantities['l4'] === 1;

          if (!isAppAccessible) {
            return (
              <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans">
                <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm animate-in fade-in zoom-in duration-300">
                  <div className="flex justify-center mb-6"><div className="bg-slate-800 p-4 rounded-full text-white shadow-lg"><KeyRound size={32} /></div></div>
                  <h1 className="text-2xl font-bold text-center text-slate-800 mb-2">H2 Logistique</h1>
                  <p className="text-center text-slate-500 mb-6 text-sm">Accès sécurisé au calculateur</p>
                  <form onSubmit={handleAccessSubmit}>
                    <input type="password" value={accessCode} onChange={(e) => setAccessCode(e.target.value)} placeholder="Code d'accès" className="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-slate-500 outline-none text-center text-lg tracking-widest transition-all" autoFocus />
                    {accessError && <p className="text-red-500 text-xs text-center mb-4 font-medium bg-red-50 p-2 rounded">{accessError}</p>}
                    <button type="submit" className="w-full py-3 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-700 transition-all transform active:scale-95">Entrer</button>
                  </form>
                </div>
              </div>
            );
          }

          if (view === 'admin') return <AdminPage prices={prices} setPrices={setPrices} matrixData={matrixData} setMatrixData={setMatrixData} initialData={INITIAL_DATA} onBack={() => setView('calculator')} />;

          return (
            <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans text-slate-800">
              <div className="max-w-4xl mx-auto">
                <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 no-print">
                  <div className="flex items-center gap-3"><div><h1 className="text-2xl font-extrabold text-slate-800">H2 Logistique</h1><p className="text-slate-500 text-sm">Calculateur de prix déménagement</p></div></div>
                  <div className="flex items-center gap-2">
                    <button onClick={handleGlobalClear} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 text-sm font-medium rounded-full shadow-sm border border-red-200 hover:bg-red-100 transition-colors mr-2"><RotateCcw size={16} /> Tout Effacer</button>
                    <button onClick={() => setShowLogin(true)} className="flex items-center gap-2 px-4 py-2 bg-white text-slate-600 text-sm font-medium rounded-full shadow-sm border border-slate-200 hover:bg-slate-50 transition-colors"><Lock size={16} /> Admin</button>
                  </div>
                </header>

                {showLogin && (
                  <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm animate-in fade-in zoom-in duration-200">
                      <h2 className="text-xl font-bold mb-4">Accès Administrateur</h2>
                      <form onSubmit={handleLogin}>
                        <input type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} placeholder="Code" autoFocus className="w-full p-3 border border-slate-300 rounded-lg mb-2 focus:ring-2 focus:ring-blue-500 outline-none" />
                        {loginError && <p className="text-red-500 text-sm mb-3">{loginError}</p>}
                        <div className="flex gap-2 justify-end mt-4">
                          <button type="button" onClick={() => { setShowLogin(false); setLoginError(''); setPasswordInput(''); }} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Annuler</button>
                          <button type="submit" className="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Valider</button>
                        </div>
                      </form>
                    </div>
                  </div>
                )}

                <TableSection title="1. Prestation de Service" items={INITIAL_DATA.prestation} colorClass="bg-slate-800 text-white" quantities={quantities} prices={prices} onQuantityChange={handleQuantityChange} formatCurrency={formatCurrency} calculateRowTotal={calculateRowTotal} onClear={handleClearSection} defaultExpanded={true} />
                <TableSection title="2. Monte Meuble et AOT" items={INITIAL_DATA.ra_monte_meuble} colorClass="bg-slate-800 text-white" quantities={quantities} prices={prices} onQuantityChange={handleQuantityChange} formatCurrency={formatCurrency} calculateRowTotal={calculateRowTotal} onClear={handleClearSection} defaultExpanded={false} />
                <TableSection title="3. Matériel & Livraison" items={INITIAL_DATA.materiel} colorClass="bg-slate-800 text-white" quantities={quantities} prices={prices} onQuantityChange={handleQuantityChange} formatCurrency={formatCurrency} calculateRowTotal={calculateRowTotal} onClear={handleClearSection} defaultExpanded={false} />
                <TableSection title="4. Longue Distance" items={INITIAL_DATA.distance} colorClass="bg-slate-800 text-white" quantities={quantities} prices={prices} onQuantityChange={handleQuantityChange} formatCurrency={formatCurrency} calculateRowTotal={calculateRowTotal} onClear={handleClearSection} defaultExpanded={false} quantityLabel="Saisie" disableQuantityInput={false} />

                <div className="bg-white rounded-lg shadow-lg border border-slate-200 overflow-hidden mb-12">
                    <div className="bg-slate-800 text-white px-6 py-4"><h3 className="font-bold text-lg">Tableau Récapitulatif des Offres</h3></div>
                    <div className="p-6">
                        <div className="mb-6 flex flex-col md:flex-row items-center gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <label className="text-sm font-semibold text-slate-700 whitespace-nowrap">Remise / Majoration Commerciale :</label>
                            <select value={adjustment} onChange={(e) => setAdjustment(parseInt(e.target.value))} className="w-full md:w-64 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="-15">- 15% (Remise)</option>
                                <option value="-10">- 10% (Remise)</option>
                                <option value="-5">- 5% (Remise)</option>
                                <option value="0">0%</option>
                                <option value="5">+ 5% (Majoration)</option>
                                <option value="10">+ 10% (Majoration)</option>
                                <option value="15">+ 15% (Majoration)</option>
                            </select>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="border border-slate-200 rounded-lg overflow-hidden">
                                <div className="bg-blue-50 p-4 text-center border-b border-blue-100"><h4 className="font-bold text-blue-900 uppercase tracking-wider">Standard</h4></div>
                                <div className="p-4 space-y-2">
                                    <div className="flex justify-between text-sm text-slate-500"><span>Total HT :</span><span>{formatCurrency(baseTotal)}</span></div>
                                    <div className="flex justify-between text-sm text-slate-500 border-b border-slate-100 pb-2"><span>Ajustement :</span><span className={adjustment < 0 ? 'text-green-600' : (adjustment > 0 ? 'text-red-600' : 'text-slate-600')}>{adjustment}% ({formatCurrency(standardAdjAmount)})</span></div>
                                    <div className="pt-2 text-center"><span className="block text-xs text-slate-400 uppercase">Total TTC</span><span className="block text-2xl font-bold text-slate-800">{formatCurrency(standardFinal)}</span></div>
                                </div>
                            </div>
                            <div className="border border-purple-200 rounded-lg overflow-hidden shadow-sm relative">
                                <div className="bg-purple-50 p-4 text-center border-b border-purple-100"><h4 className="font-bold text-purple-900 uppercase tracking-wider">Confort</h4></div>
                                <div className="p-4 space-y-2">
                                    <div className="flex justify-between text-sm text-slate-500"><span>Total HT :</span><span>{formatCurrency(confortTotalBase)}</span></div>
                                    <div className="flex justify-between text-sm text-slate-500 border-b border-slate-100 pb-2"><span>Ajustement :</span><span className={adjustment < 0 ? 'text-green-600' : (adjustment > 0 ? 'text-red-600' : 'text-slate-600')}>{adjustment}% ({formatCurrency(confortAdjAmount)})</span></div>
                                    <div className="pt-2 text-center"><span className="block text-xs text-slate-400 uppercase">Total TTC</span><span className="block text-2xl font-bold text-purple-700">{formatCurrency(confortFinal)}</span></div>
                                </div>
                            </div>
                            <div className={`border rounded-lg overflow-hidden ${isGroupageActive ? 'border-teal-200' : 'border-orange-200'}`}>
                                <div className={`${isGroupageActive ? 'bg-teal-50 border-teal-100' : 'bg-orange-50 border-orange-100'} p-4 text-center border-b`}><h4 className={`font-bold uppercase tracking-wider ${isGroupageActive ? 'text-teal-900' : 'text-orange-900'}`}>{isGroupageActive ? 'Groupage' : 'Longue Distance'}</h4></div>
                                <div className="p-4 space-y-2">
                                    <div className="flex justify-between text-sm text-slate-500"><span>Total HT :</span><span>{formatCurrency(thirdOfferTotalBase)}</span></div>
                                    <div className="flex justify-between text-sm text-slate-500 border-b border-slate-100 pb-2"><span>Ajustement :</span><span className={adjustment < 0 ? 'text-green-600' : (adjustment > 0 ? 'text-red-600' : 'text-slate-600')}>{adjustment}% ({formatCurrency(thirdOfferAdjAmount)})</span></div>
                                    <div className="pt-2 text-center"><span className="block text-xs text-slate-400 uppercase">Total TTC</span><span className={`block text-2xl font-bold ${isGroupageActive ? 'text-teal-800' : 'text-slate-800'}`}>{formatCurrency(thirdOfferFinal)}</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end no-print">
                            <button onClick={() => window.print()} className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-2 px-4 py-2 border border-blue-200 rounded-full hover:bg-blue-50 transition-colors">
                                <Save size={16} /> Imprimer / Sauvegarder le Devis
                            </button>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>